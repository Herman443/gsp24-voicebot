<html lang="en">
<head>
    <meta charset="UTF-8">
    <style>
        #responseContainer::-webkit-scrollbar {
            width: 8px;
            background: transparent;
        }
        #responseContainer::-webkit-scrollbar-track {
            background: transparent;
        }
        #responseContainer::-webkit-scrollbar-thumb {
            background: #d3d3d3;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div style="display: flex; width: 99vw; justify-content: center;">
        <div style="display:flex; flex-direction: column; align-items: center; justify-content: center; width: 30vw; height: 85vh; border-radius: 16px; border: 1px solid black; padding: 8px;" id="app-container">
            <br/>
            <div id="welcome-message" class="welcome-message" style="border-radius: 16px; background-color: #6879D0; color: white; width: fit-content; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);">Welcome! Press "Start Streaming" to record.</div>
            <br />
            <div style="display: flex; flex-direction: column; height: 100%; overflow-y: scroll; width: 100%; border-bottom: 1px solid black; border-top: 1px solid black;" id="responseContainer"></div>
            <br/>
            <div style="display: flex; flex-direction: row; width: fit-content; gap: 24px;">
                <button style="border-radius: 16px; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px;" id="startButton">Start Streaming</button>
                <button style="border-radius: 16px; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px;" id="stopButton" disabled>Stop Streaming</button>
            </div>
            <br/>
            <button style="border-radius: 16px; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px;" id="interruptButton" disabled>Interrupt AI</button>
            <br/>
            <audio src="data:audio" id="audio" controls autoplay></audio>
        </div>
    </div>
    <script src="https://www.WebRTC-Experiment.com/RecordRTC.js"></script>
    <script>
        var protocol = window.location.protocol === 'http:' ? 'ws' : 'wss';
        let ws = new WebSocket(protocol + '://' + window.location.host + '/web/websocket');
        let mediaRecorder;
        let recorder;
        var isPausedByButton = false;
        var isPausedByAI = false;
        var isAudioPlaying = false;
        var timeout;
        var audio = document.getElementById("audio");

        ws.onmessage = event => {
            if (!(event.data instanceof Blob)) {
                if (event.data == "stop_recording"){
                    recorder.pauseRecording();
                    isPausedByAI = true;
                    let responseContainer = document.getElementById('responseContainer');
                    responseContainer.innerHTML += `<br><b style="font-size: 12px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); background-color: #afcdd6; color:white; width: fit-content; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px; align-self:center;">~~ Paused recording ~~</b><br>`;
                    responseContainer.scrollTop = responseContainer.scrollHeight;
                    return;
                }
                let responseContainer = document.getElementById('responseContainer');
                if(event.data.includes("RECOGNIZED:")){
                    responseContainer.innerHTML += `<p style="border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); background-color: #6879D0; color:white; width: fit-content; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px; margin-left: 24px; align-self:flex-end;">${event.data.replace("RECOGNIZED: ", "")}</p>`;
                } else {
                    responseContainer.innerHTML += `<p style="border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: 1px solid gray; background-color: white; color:black; width: fit-content; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px; margin-right: 24px; align-self:flex-start;">${event.data}</p>`;
                }
                responseContainer.scrollTop = responseContainer.scrollHeight;
				return;				
        	}
 
        	console.log('blob received: ' + event.data.size);
        	blobToBase64(event.data).then(b64 => {
                recorder.pauseRecording();
                isPausedByAI = true;
        		audio.src = "data:audio/x-wav;base64," + b64;
                audio.load();
                audio.play();
                document.getElementById('startButton').disabled = true;
                document.getElementById('interruptButton').disabled = false;
                audio.onloadedmetadata = function() {
                    timeout = setTimeout (() => {
                        if (!isPausedByButton) {
                            recorder.resumeRecording();
                            isPausedByAI = false;
                            let responseContainer = document.getElementById('responseContainer');
                            responseContainer.innerHTML += `<br><b style="font-size: 12px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); background-color: #afcdd6; color:white; width: fit-content; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px; align-self:center;">~~ Recording ~~</b><br>`;
                            responseContainer.scrollTop = responseContainer.scrollHeight;
                        }
                        if (isPausedByButton) {
                            document.getElementById('startButton').disabled = false;
                        }
                        document.getElementById('interruptButton').disabled = true;
                    }, audio.duration*1000 + 1500);
                };
        	});
        };

        let handleDataAvailable = (event) => {
            if (event.size > 0) {
                console.log('blob', event)
                blobToBase64(event).then(b64 => {
                    ws.send(b64)
                })
            }
        };

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                recorder = RecordRTC(stream, {
                    type: 'audio',
                    recorderType: StereoAudioRecorder,
                    mimeType: 'audio/wav',
                    timeSlice: 500,
                    desiredSampRate: 16000,
                    numberOfAudioChannels: 1,
                    ondataavailable: handleDataAvailable
                });

                document.getElementById('startButton').addEventListener('click', () => {
                    if (recorder.state == 'paused') {
                    recorder.resumeRecording();
                    } else {
                        recorder.startRecording();
                    }
                    isPausedByButton = false;
                    document.getElementById('startButton').disabled = true;
                    document.getElementById('stopButton').disabled = false;
                    let responseContainer = document.getElementById('responseContainer');
                    responseContainer.innerHTML += `<br><b style="font-size: 12px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); background-color: #afcdd6; color:white; width: fit-content; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px; align-self:center;">~~ Recording ~~</b><br>`;
                    responseContainer.scrollTop = responseContainer.scrollHeight;
                });

                document.getElementById('stopButton').addEventListener('click', () => {
                        recorder.pauseRecording();
                        isPausedByButton = true;
                        document.getElementById('stopButton').disabled = true;
                        if (!audio.paused) {
                            document.getElementById('interruptButton').disabled = false;
                        } else {
                            document.getElementById('interruptButton').disabled = true;
                        }
                        if (isPausedByAI) {
                            document.getElementById('startButton').disabled = true;
                        } else {
                            document.getElementById('startButton').disabled = false;
                        }
                        isPausedByAI = false;
                        let responseContainer = document.getElementById('responseContainer');
                        responseContainer.innerHTML += `<br><b style="font-size: 12px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); background-color: #afcdd6; color:white; width: fit-content; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px; align-self:center;">~~ Stopped Recording ~~</b><br>`;
                        responseContainer.scrollTop = responseContainer.scrollHeight;
                });

                document.getElementById('interruptButton').addEventListener('click', () => {
                    audio.pause();
                    document.getElementById('interruptButton').disabled = true;
                    clearTimeout(timeout);

                    if (recorder.state === 'paused') {
                        recorder.resumeRecording();
                    } else {
                        recorder.startRecording();
                    }
                    document.getElementById('startButton').disabled = true;
                    if (isPausedByButton) {
                        document.getElementById('stopButton').disabled = true;
                    } else {
                        document.getElementById('stopButton').disabled = false;
                    }

                    let responseContainer = document.getElementById('responseContainer');
                    responseContainer.innerHTML += `<br><b style="font-size: 12px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); background-color: #afcdd6; color:white; width: fit-content; padding-top: 8px; padding-bottom: 8px; padding-left: 24px; padding-right: 24px; align-self:center;">~~ Stopped Recording ~~</b><br>`;                    responseContainer.scrollTop = responseContainer.scrollHeight;
                });
            });

        ws.onopen = () => {
            console.log('WebSocket connection opened');
        };

        ws.onclose = () => {
            recorder.stopRecording();
            console.log('WebSocket connection closed');
        };

        function readWelcomeMessage() {
            const welcomeMessage = document.getElementById('welcome-message').innerText;
            const speech = new SpeechSynthesisUtterance(welcomeMessage);
            speechSynthesis.speak(speech);
        }

        window.onload = () => {
            readWelcomeMessage();
        };

    </script>
</body>
</html>